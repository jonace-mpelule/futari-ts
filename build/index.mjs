import"reflect-metadata";import{v4 as e,v5 as t}from"uuid";import n,{readdir as r}from"node:fs/promises";import{createServer as i}from"node:http";import a from"node:path";import o,{Chalk as s}from"chalk";import c from"signale";import l from"node:fs";import u from"prettier";import{build as d}from"tsdown";const f=Symbol(`def:route`),p=Symbol(`routes`),m=Symbol(`middlewares`),h=`6ba7b811-9dad-11d1-80b4-00c04fd430c8`;function g(){return t=>{let n=e();Reflect.defineMetadata(f,{id:n,isRouter:!0},t)}}function _(e){return(n,r,i)=>{let a=n.constructor,o=Reflect.getMetadata(f,a),s=Reflect.getMetadata(m,a)||[],c=t(`${o?.id}:${r}`,h);s.push({id:c,handlerKey:r,handler:e}),Reflect.defineMetadata(m,s,a)}}function v(e){return(n,r,i)=>{let a=n.constructor,o=Reflect.getMetadata(f,a),s=Reflect.getMetadata(p,a)||[],c=t(`${o?.id}:${r}`,h);s.push({id:c,method:`GET`,path:e,handlerKey:r,middlewares:[]}),Reflect.defineMetadata(p,s,a)}}function y(e){return(t,n,r)=>{t.__routes||=[],t.__routes.push({method:`POST`,path:e,handlerKey:n})}}function b(e){return(t,n,r)=>{t.__routes||=[],t.__routes.push({method:`PUT`,path:e,handlerKey:n})}}function x(e){return(t,n,r)=>{t.__routes||=[],t.__routes.push({method:`PATCH`,path:e,handlerKey:n})}}function S(e){return(t,n,r)=>{t.__routes||=[],t.__routes.push({method:`DELETE`,path:e,handlerKey:n})}}function C(e){return(t,n,r)=>{t.__routes||=[],t.__routes.push({method:`HEAD`,path:e,handlerKey:n})}}function w(e){return(t,n,r)=>{t.__routes||=[],t.__routes.push({method:`OPTIONS`,path:e,handlerKey:n})}}function T(e){return(t,n,r)=>{t.__routes||=[],t.__routes.push({method:`CONNECT`,path:e,handlerKey:n})}}function E(e){return(t,n,r)=>{t.__routes||=[],t.__routes.push({method:`TRACE`,path:e,handlerKey:n})}}const D=async e=>{let t;e.endsWith(`/+route.ts`)?t=await import(e):(c.log(o.red(`Error:`),`${e.split(`/routes`)[1]} has no default class or +route.ts file is not defined`),process.exit(1)),typeof t.default!=`function`&&(c.log(o.red(`Error:`),`${e.split(`/routes`)[1]} has no default class or +route.ts file is not defined`),process.exit(1));let n=Reflect.getMetadata(f,t.default)??void 0;(!n||!n.isRouter)&&(c.log(o.bgRed(`Error:`),`${e.split(`/routes/`)[1]} is not a valid router please attach '@DefRoute()' to the default class `),process.exit(1))},O=async e=>{try{let t=await import(e),n=Reflect.getMetadata(p,t.default)||[],r=Reflect.getMetadata(m,t.default)||[];for(let e of r??[]){let t=n.findIndex(t=>t.id===e.id&&t.handlerKey===e.handlerKey);t!==-1&&n[t]?.middlewares.push(e)}return n}catch(e){console.log(`proccess routes`,e)}},k=async({func:e,req:t,res:n})=>e(t,n);async function A(e){let t=[];try{let n=await r(e,{withFileTypes:!0});for(let r of n){let n=a.join(e,r.name);r.isDirectory()&&(t.push(n),t=t.concat(await A(n)))}}catch{}return t}async function j(e){let t=await import(`tcp-port-used`);return new Promise((n,r)=>{t.check(e,`127.0.0.1`).then(e=>{n({isInUse:e})},e=>{r(e.message)})})}async function M(e){let t=process.stdout.write,n=process.stderr.write;process.stdout.write=(()=>!0),process.stderr.write=(()=>!0);try{return await e()}finally{process.stdout.write=t,process.stderr.write=n}}async function N(e){await l.promises.mkdir(a.join(e,`.futari`),{recursive:!0});let t=await A(`${e}/src/routes`),n=[];a.join(e,`.futari`);for(let e of t){let t=(e.split(`src/routes`)[1]??`/`).replace(`[id]`,`:id`);n.push({baseRoute:t,subRoutes:[],filePath:e})}for(let e of n)D(`${e.filePath}/+route.ts`);await Promise.all(n.map(async(e,t)=>{let r=await O(`${e.filePath}/+route.ts`);n[t].subRoutes=r??[]})),n.flatMap(e=>e.subRoutes.map(t=>({[`${t.method}:${e.baseRoute}${t.path}`]:``})));let r=new Map,i=n.filter(e=>e.filePath!==null||e.filePath!==``),o=await P({filePaths:i.map(e=>e.filePath+`/+route.ts`),root:e});console.log(o);for(let e=0;e<o.length;e++){i[e].filePath=o[e];let t=`__Route__${r.size}__`;r.set(i[e]?.filePath,{className:t,path:o[e]})}let s=`
        /**
         * ! IMPORTANT FILE - DO NOT DELETE
         *
         * This manifest file is generated at build time.
         * It contains all route definitions for the backend framework.
         * 
         * Each route includes:
         *   - HTTP method
         *   - Full path
         *   - Handler function (bound to its class instance)
         *   - Optional middlewares
         *
         * The imports and class instances are fully resolved at build time,
         * so no filesystem scanning or dynamic imports are required at runtime.
         */
        
        ${[...r.values()].map(e=>`import ${e.className} from './chunks/${e.path}'`).join(`
`)}
        
        /**
         * Instances of route classes
         * Each class is instantiated once and reused for all its subRoutes
         */
        ${[...r.values()].map(e=>`const ${e.className.toLowerCase()} = new ${e.className}()`).join(`
`)}
        
        /**
         * Exported routes array
         * Each object contains:
         *  - method: HTTP verb (GET, POST, etc.)
         *  - path: full route path
         *  - handler: class method bound to instance
         *  - middlewares: array of middleware functions
         */
        export default {
          routes: [
            ${i.flatMap(e=>{let{className:t}=r.get(e.filePath),n=t.toLowerCase();return e.subRoutes.map(t=>`{ method: '${t.method}', path: '${e.baseRoute}${t.path}', handler: ${n}.${t.handlerKey}.bind(${n}), middlewares: [] }`)}).join(`,
`)}
          ]
        }
        `.trim(),c=await u.format(s,{parser:`babel`});await l.promises.writeFile(a.join(e,`.futari`,`manifest.js`),c)}async function P({filePaths:e,root:t}){return[...(await M(()=>d({entry:e,outDir:`${t}/.futari/chunks`,format:`esm`,skipNodeModulesBundle:!1,unbundle:!1,clean:!0,logLevel:`silent`,sourcemap:!1}))).flatMap(e=>e.chunks.map(e=>e.fileName))].slice(0,-1)}const F={CONTINUE:100,SWITCHING_PROTOCOLS:101,PROCESSING:102,EARLY_HINTS:103,OK:200,CREATED:201,ACCEPTED:202,NON_AUTHORITATIVE_INFORMATION:203,NO_CONTENT:204,RESET_CONTENT:205,PARTIAL_CONTENT:206,MULTI_STATUS:207,ALREADY_REPORTED:208,IM_USED:226,MULTIPLE_CHOICES:300,MOVED_PERMANENTLY:301,FOUND:302,SEE_OTHER:303,NOT_MODIFIED:304,USE_PROXY:305,TEMPORARY_REDIRECT:307,PERMANENT_REDIRECT:308,BAD_REQUEST:400,UNAUTHORIZED:401,PAYMENT_REQUIRED:402,FORBIDDEN:403,NOT_FOUND:404,METHOD_NOT_ALLOWED:405,NOT_ACCEPTABLE:406,PROXY_AUTHENTICATION_REQUIRED:407,REQUEST_TIMEOUT:408,CONFLICT:409,GONE:410,LENGTH_REQUIRED:411,PRECONDITION_FAILED:412,PAYLOAD_TOO_LARGE:413,URI_TOO_LONG:414,UNSUPPORTED_MEDIA_TYPE:415,RANGE_NOT_SATISFIABLE:416,EXPECTATION_FAILED:417,IM_A_TEAPOT:418,MISDIRECTED_REQUEST:421,UNPROCESSABLE_ENTITY:422,LOCKED:423,FAILED_DEPENDENCY:424,TOO_EARLY:425,UPGRADE_REQUIRED:426,PRECONDITION_REQUIRED:428,TOO_MANY_REQUESTS:429,REQUEST_HEADER_FIELDS_TOO_LARGE:431,UNAVAILABLE_FOR_LEGAL_REASONS:451,INTERNAL_SERVER_ERROR:500,NOT_IMPLEMENTED:501,BAD_GATEWAY:502,SERVICE_UNAVAILABLE:503,GATEWAY_TIMEOUT:504,HTTP_VERSION_NOT_SUPPORTED:505,VARIANT_ALSO_NEGOTIATES:506,INSUFFICIENT_STORAGE:507,LOOP_DETECTED:508,NOT_EXTENDED:510,NETWORK_AUTHENTICATION_REQUIRED:511};var I=class{eventListeners={};on(e,t){let n=this.eventListeners[e]??new Set;n.add(t),this.eventListeners[e]=n}emit(e,...t){let n=this.eventListeners[e];for(let e of n)e(...t)}};function L(e,t){return e.length>=t?e.slice(0,t):e.padEnd(t,` `)}function R(e){return e>=500?o.red(e):e>=400?o.yellow(e):e>=300?o.cyan(e):o.green(e)}function z(e){return e>1e3?o.red(`${e.toFixed(3)}ms`):e>500?o.yellow(`${e.toFixed(3)}ms`):o.grey(`${e.toFixed(3)}ms`)}const B=new I;B.on(`api:log`,(e,t,n,r)=>{let i=performance.now()-e,a=L(n?.toUpperCase()??`GET`,6),s=L(r.toString(),6),l=L(t??`/`,10);c.log(o.bold(a),R(Number(s)),l,z(i))});async function V(e){return new Promise((t,n)=>{let r=``;e.on(`data`,e=>{r+=e.toString()}),e.on(`end`,()=>{t(JSON.parse(r))})})}function H({middlewares:e,req:t,res:n,onRunRoute:r}){let i=0,a=!1;function o(s){if(a)return;if(s){console.log(s),a=!0,n.end(JSON.stringify({message:`error`})),n.writeHead(F.INTERNAL_SERVER_ERROR),n.end(JSON.stringify({message:`Internal Server Error`})),B.emit(`api:log`,t.__meta.startTime,t.url,t.method,F.INTERNAL_SERVER_ERROR);return}if(n.writableEnded){B.emit(`api:log`,t.__meta.startTime,t.url,t.method,n.statusCode),a=!0;return}let c=e[i++];if(!c){a=!0;try{r(t,n)}catch{n.writeHead(F.INTERNAL_SERVER_ERROR),n.end(JSON.stringify({message:`Internal Server Error`})),B.emit(`api:log`,t.__meta.startTime,t.url,t.method,F.INTERNAL_SERVER_ERROR)}return}try{let e=c.handler({req:t,res:n,next:o});e instanceof Promise&&e.catch(o)}catch(e){o(e)}}o()}async function U({req:e,res:t,routes:n}){e.__meta??={};let r=performance.now();e.__meta.startTime=r;let i=n.filter(t=>e.url?.startsWith(t.path));if(!i.length)return W({req:e,res:t});for(let n of i){if(n.method.toLocaleLowerCase()!==e.method?.toLocaleLowerCase())return W({req:e,res:t});let r={};[`post`,`patch`,`put`].includes(e.method.toLocaleLowerCase())&&(r=await V(e),e.body=r),H({middlewares:n.middlewares.reverse(),req:e,res:t,onRunRoute:async(e,t)=>{await k({func:n.handler,req:e,res:t})}})}}function W({req:e,res:t}){return t.writeHead(F.NOT_FOUND,{"content-type":`application/json`}),B.emit(`api:log`,e.__meta.startTime,e.url,e.method,F.NOT_FOUND),t.end(JSON.stringify({message:`Route Not Found`}))}function G(){let e;return{config:t=>{e=t},serve:async t=>{let r=new s,o=Date.now();process.argv.includes(`--build`)&&await N(e.root);let l=a.join(e.root,`./.futari`,`manifest.js`);try{await n.access(l)}catch{c.log(`Error: Manifest Not Found. Please run build command`),process.exit(1)}let u=(await import(l)).default.routes;(await j(e.port)).isInUse&&(c.error(`Port is already in use by another process.`),process.exit(1));let d=await import(`ip`),f=`Local: `.padEnd(10),p=`Network: `.padEnd(10);c.log(`\n${f}`,`http://localhost:${e.port}`),c.log(p,`http://${d.address()}:${e.port}\n`),i(async(e,t)=>{U({req:e,res:t,routes:u})}).listen(e.port,`0.0.0.0`,async()=>{if(t!==void 0)t();else{let e=((Date.now()-o)/1e3).toFixed(2);c.info(r.yellow(`Booting Up...`)),c.success(`Server is ready! (${e}s)`,`

`)}})}}}function K(e,t){return async(n,r)=>{try{let i=await e({req:n,res:r}),a=t?.transform?t.transform(i):i,o=t?.successStatus??200;r.writeHead(o),r.end(JSON.stringify(a)),B.emit(`api:log`,n.__meta.startTime,n.url,n.method,o);return}catch{r.writeHead(F.INTERNAL_SERVER_ERROR),r.end(JSON.stringify({message:`Internal Server Error`})),B.emit(`api:log`,n.__meta.startTime,n.url,n.method,F.INTERNAL_SERVER_ERROR);return}}}export{T as Connect,g as DefRoute,S as Delete,v as Get,C as Head,w as Options,x as Patch,y as Post,b as Put,G as Server,E as Trace,_ as Use,K as controllerHandler};
//# sourceMappingURL=index.mjs.map