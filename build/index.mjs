import"reflect-metadata";import{v4 as e,v5 as t}from"uuid";import n,{readdir as r}from"node:fs/promises";import{createServer as i}from"node:http";import a from"node:path";import o,{Chalk as s}from"chalk";import c from"signale";import l from"node:fs";import u from"prettier";const d=Symbol(`def:route`),f=Symbol(`routes`),p=Symbol(`middlewares`),m=`6ba7b811-9dad-11d1-80b4-00c04fd430c8`;function h(){return t=>{let n=e();Reflect.defineMetadata(d,{id:n,isRouter:!0},t)}}function g(e){return(n,r,i)=>{let a=n.constructor,o=Reflect.getMetadata(d,a),s=Reflect.getMetadata(p,a)||[],c=t(`${o?.id}:${r}`,m);s.push({id:c,handlerKey:r,handler:e}),Reflect.defineMetadata(p,s,a)}}function _(e){return(n,r,i)=>{let a=n.constructor,o=Reflect.getMetadata(d,a),s=Reflect.getMetadata(f,a)||[],c=t(`${o?.id}:${r}`,m);s.push({id:c,method:`GET`,path:e,handlerKey:r,middlewares:[]}),Reflect.defineMetadata(f,s,a)}}function v(e){return(t,n,r)=>{t.__routes||=[],t.__routes.push({method:`POST`,path:e,handlerKey:n})}}function y(e){return(t,n,r)=>{t.__routes||=[],t.__routes.push({method:`PUT`,path:e,handlerKey:n})}}function b(e){return(t,n,r)=>{t.__routes||=[],t.__routes.push({method:`PATCH`,path:e,handlerKey:n})}}function x(e){return(t,n,r)=>{t.__routes||=[],t.__routes.push({method:`DELETE`,path:e,handlerKey:n})}}function S(e){return(t,n,r)=>{t.__routes||=[],t.__routes.push({method:`HEAD`,path:e,handlerKey:n})}}function C(e){return(t,n,r)=>{t.__routes||=[],t.__routes.push({method:`OPTIONS`,path:e,handlerKey:n})}}function w(e){return(t,n,r)=>{t.__routes||=[],t.__routes.push({method:`CONNECT`,path:e,handlerKey:n})}}function T(e){return(t,n,r)=>{t.__routes||=[],t.__routes.push({method:`TRACE`,path:e,handlerKey:n})}}const E=async e=>{let t=await import(e);typeof t.default!=`function`&&(c.log(o.red(`Error:`),`${e.split(`/routes`)[1]} has no default class or +route.ts file is not defined`),process.exit(1));let n=Reflect.getMetadata(d,t.default)??void 0;(!n||!n.isRouter)&&(c.log(o.bgRed(`Error:`),`${e.split(`/routes/`)[1]} is not a valid router please attach '@DefRoute()' to the default class `),process.exit(1))},D=async e=>{try{let t=await import(e),n=Reflect.getMetadata(f,t.default)||[],r=Reflect.getMetadata(p,t.default)||[];for(let e of r??[]){let t=n.findIndex(t=>t.id===e.id&&t.handlerKey===e.handlerKey);t!==-1&&n[t]?.middlewares.push(e)}return n}catch(e){console.log(`proccess routes`,e)}},O=async({func:e,req:t,res:n})=>e(t,n);async function k(e){let t=[];try{let n=await r(e,{withFileTypes:!0});for(let r of n){let n=a.join(e,r.name);r.isDirectory()&&(t.push(n),t=t.concat(await k(n)))}}catch{}return t}async function A(e){let t=await import(`tcp-port-used`);return new Promise((n,r)=>{t.check(e,`127.0.0.1`).then(e=>{n({isInUse:e})},e=>{r(e.message)})})}async function j(e){await l.promises.mkdir(a.join(e,`.futari`),{recursive:!0});let t=await k(`${e}/src/routes`),n=[],r=a.join(e,`.futari`);for(let e of t){let t=(e.split(`src/routes`)[1]??`/`).replace(`[id]`,`:id`);n.push({baseRoute:t,subRoutes:[],filePath:e})}for(let e of n)E(`${e.filePath}/+route.ts`);await Promise.all(n.map(async(e,t)=>{let r=await D(`${e.filePath}/+route.ts`);n[t].subRoutes=r??[]})),n.flatMap(e=>e.subRoutes.map(t=>({[`${t.method}:${e.baseRoute}${t.path}`]:``})));let i=new Map;n.forEach(e=>{if(!i.has(e.filePath)){let t=`__Route__${i.size}__`,n=a.relative(r,e.filePath).replace(/\\/g,`/`);i.set(e.filePath,{className:t,importPath:n})}});let o=`
        /**
         * ! IMPORTANT FILE - DO NOT DELETE
         *
         * This manifest file is generated at build time.
         * It contains all route definitions for the backend framework.
         * 
         * Each route includes:
         *   - HTTP method
         *   - Full path
         *   - Handler function (bound to its class instance)
         *   - Optional middlewares
         *
         * The imports and class instances are fully resolved at build time,
         * so no filesystem scanning or dynamic imports are required at runtime.
         */
        
        ${[...i.values()].map(e=>`import ${e.className} from '${e.importPath}/+route.ts'`).join(`
`)}
        
        /**
         * Instances of route classes
         * Each class is instantiated once and reused for all its subRoutes
         */
        ${[...i.values()].map(e=>`const ${e.className.toLowerCase()} = new ${e.className}()`).join(`
`)}
        
        /**
         * Exported routes array
         * Each object contains:
         *  - method: HTTP verb (GET, POST, etc.)
         *  - path: full route path
         *  - handler: class method bound to instance
         *  - middlewares: array of middleware functions
         */
        export default {
          routes: [
            ${n.flatMap(e=>{let{className:t}=i.get(e.filePath),n=t.toLowerCase();return e.subRoutes.map(t=>`{ method: '${t.method}', path: '${e.baseRoute}${t.path}', handler: ${n}.${t.handlerKey}.bind(${n}), middlewares: [] }`)}).join(`,
`)}
          ]
        }
        `.trim(),s=await u.format(o,{parser:`babel`});await l.promises.writeFile(a.join(e,`.futari`,`manifest.js`),s)}const M={CONTINUE:100,SWITCHING_PROTOCOLS:101,PROCESSING:102,EARLY_HINTS:103,OK:200,CREATED:201,ACCEPTED:202,NON_AUTHORITATIVE_INFORMATION:203,NO_CONTENT:204,RESET_CONTENT:205,PARTIAL_CONTENT:206,MULTI_STATUS:207,ALREADY_REPORTED:208,IM_USED:226,MULTIPLE_CHOICES:300,MOVED_PERMANENTLY:301,FOUND:302,SEE_OTHER:303,NOT_MODIFIED:304,USE_PROXY:305,TEMPORARY_REDIRECT:307,PERMANENT_REDIRECT:308,BAD_REQUEST:400,UNAUTHORIZED:401,PAYMENT_REQUIRED:402,FORBIDDEN:403,NOT_FOUND:404,METHOD_NOT_ALLOWED:405,NOT_ACCEPTABLE:406,PROXY_AUTHENTICATION_REQUIRED:407,REQUEST_TIMEOUT:408,CONFLICT:409,GONE:410,LENGTH_REQUIRED:411,PRECONDITION_FAILED:412,PAYLOAD_TOO_LARGE:413,URI_TOO_LONG:414,UNSUPPORTED_MEDIA_TYPE:415,RANGE_NOT_SATISFIABLE:416,EXPECTATION_FAILED:417,IM_A_TEAPOT:418,MISDIRECTED_REQUEST:421,UNPROCESSABLE_ENTITY:422,LOCKED:423,FAILED_DEPENDENCY:424,TOO_EARLY:425,UPGRADE_REQUIRED:426,PRECONDITION_REQUIRED:428,TOO_MANY_REQUESTS:429,REQUEST_HEADER_FIELDS_TOO_LARGE:431,UNAVAILABLE_FOR_LEGAL_REASONS:451,INTERNAL_SERVER_ERROR:500,NOT_IMPLEMENTED:501,BAD_GATEWAY:502,SERVICE_UNAVAILABLE:503,GATEWAY_TIMEOUT:504,HTTP_VERSION_NOT_SUPPORTED:505,VARIANT_ALSO_NEGOTIATES:506,INSUFFICIENT_STORAGE:507,LOOP_DETECTED:508,NOT_EXTENDED:510,NETWORK_AUTHENTICATION_REQUIRED:511};var N=class{eventListeners={};on(e,t){let n=this.eventListeners[e]??new Set;n.add(t),this.eventListeners[e]=n}emit(e,...t){let n=this.eventListeners[e];for(let e of n)e(...t)}};function P(e,t){return e.length>=t?e.slice(0,t):e.padEnd(t,` `)}function F(e){return e>=500?o.red(e):e>=400?o.yellow(e):e>=300?o.cyan(e):o.green(e)}function I(e){return e>1e3?o.red(`${e.toFixed(3)}ms`):e>500?o.yellow(`${e.toFixed(3)}ms`):o.grey(`${e.toFixed(3)}ms`)}const L=new N;L.on(`api:log`,(e,t,n,r)=>{let i=performance.now()-e,a=P(n?.toUpperCase()??`GET`,6),s=P(r.toString(),6),l=P(t??`/`,10);c.log(o.bold(a),F(Number(s)),l,I(i))});async function R(e){return new Promise((t,n)=>{let r=``;e.on(`data`,e=>{r+=e.toString()}),e.on(`end`,()=>{t(JSON.parse(r))})})}function z({middlewares:e,req:t,res:n,onRunRoute:r}){let i=0,a=!1;function o(s){if(a)return;if(s){console.log(s),a=!0,n.end(JSON.stringify({message:`error`})),n.writeHead(M.INTERNAL_SERVER_ERROR),n.end(JSON.stringify({message:`Internal Server Error`})),L.emit(`api:log`,t.__meta.startTime,t.url,t.method,M.INTERNAL_SERVER_ERROR);return}if(n.writableEnded){L.emit(`api:log`,t.__meta.startTime,t.url,t.method,n.statusCode),a=!0;return}let c=e[i++];if(!c){a=!0;try{r(t,n)}catch{n.writeHead(M.INTERNAL_SERVER_ERROR),n.end(JSON.stringify({message:`Internal Server Error`})),L.emit(`api:log`,t.__meta.startTime,t.url,t.method,M.INTERNAL_SERVER_ERROR)}return}try{let e=c.handler({req:t,res:n,next:o});e instanceof Promise&&e.catch(o)}catch(e){o(e)}}o()}async function B({req:e,res:t,routes:n}){e.__meta??={};let r=performance.now();e.__meta.startTime=r;let i=n.filter(t=>e.url?.startsWith(t.path));if(!i.length)return V({req:e,res:t});for(let n of i){if(n.method.toLocaleLowerCase()!==e.method?.toLocaleLowerCase())return V({req:e,res:t});let r={};[`post`,`patch`,`put`].includes(e.method.toLocaleLowerCase())&&(r=await R(e),e.body=r),z({middlewares:n.middlewares.reverse(),req:e,res:t,onRunRoute:async(e,t)=>{await O({func:n.handler,req:e,res:t})}})}}function V({req:e,res:t}){return t.writeHead(M.NOT_FOUND,{"content-type":`application/json`}),L.emit(`api:log`,e.__meta.startTime,e.url,e.method,M.NOT_FOUND),t.end(JSON.stringify({message:`Route Not Found`}))}function H(){let e;return{config:t=>{e=t},serve:async t=>{let r=new s,o=Date.now();await j(e.root);let l=a.join(e.root,`./.futari`,`manifest.js`);await n.exists(l)||(c.log(`Error: Manifest Not Found. Please run build command`),process.exit(1));let u=(await import(l)).default.routes;(await A(e.port)).isInUse&&(c.error(`Port is already in use by another process.`),process.exit(1));let d=await import(`ip`),f=`Local: `.padEnd(10),p=`Network: `.padEnd(10);c.log(`\n${f}`,`http://localhost:${e.port}`),c.log(p,`http://${d.address()}:${e.port}\n`),i(async(e,t)=>{B({req:e,res:t,routes:u})}).listen(e.port,`0.0.0.0`,async()=>{if(t!==void 0)t();else{let e=((Date.now()-o)/1e3).toFixed(2);c.info(r.yellow(`Booting Up...`)),c.success(`Server is ready! (${e}s)`,`

`)}})}}}function U(e,t){return async(n,r)=>{try{let i=await e({req:n,res:r}),a=t?.transform?t.transform(i):i,o=t?.successStatus??200;r.writeHead(o),r.end(JSON.stringify(a)),L.emit(`api:log`,n.__meta.startTime,n.url,n.method,o);return}catch{r.writeHead(M.INTERNAL_SERVER_ERROR),r.end(JSON.stringify({message:`Internal Server Error`})),L.emit(`api:log`,n.__meta.startTime,n.url,n.method,M.INTERNAL_SERVER_ERROR);return}}}export{w as Connect,h as DefRoute,x as Delete,_ as Get,S as Head,C as Options,b as Patch,v as Post,y as Put,H as Server,T as Trace,g as Use,U as controllerHandler};
//# sourceMappingURL=index.mjs.map