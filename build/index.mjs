import"reflect-metadata";import{v4 as e,v5 as t}from"uuid";import{createServer as n}from"node:http";import r,{Chalk as i}from"chalk";import a from"signale";import{readdir as o}from"node:fs/promises";import s from"node:path";const c=Symbol(`def:route`),l=Symbol(`routes`),u=Symbol(`middlewares`),d=`6ba7b811-9dad-11d1-80b4-00c04fd430c8`;function f(){return t=>{let n=e();Reflect.defineMetadata(c,{id:n,isRouter:!0},t)}}function p(e){return(n,r,i)=>{let a=n.constructor,o=Reflect.getMetadata(c,a),s=Reflect.getMetadata(u,a)||[],l=t(`${o?.id}:${r}`,d);s.push({id:l,handlerKey:r,handler:e}),Reflect.defineMetadata(u,s,a)}}function m(e){return(n,r,i)=>{let a=n.constructor,o=Reflect.getMetadata(c,a),s=Reflect.getMetadata(l,a)||[],u=t(`${o?.id}:${r}`,d);s.push({id:u,method:`GET`,path:e,handlerKey:r,middlewares:[]}),Reflect.defineMetadata(l,s,a)}}function h(e){return(t,n,r)=>{t.__routes||=[],t.__routes.push({method:`POST`,path:e,handlerKey:n})}}function g(e){return(t,n,r)=>{t.__routes||=[],t.__routes.push({method:`PUT`,path:e,handlerKey:n})}}function _(e){return(t,n,r)=>{t.__routes||=[],t.__routes.push({method:`PATCH`,path:e,handlerKey:n})}}function v(e){return(t,n,r)=>{t.__routes||=[],t.__routes.push({method:`DELETE`,path:e,handlerKey:n})}}function y(e){return(t,n,r)=>{t.__routes||=[],t.__routes.push({method:`HEAD`,path:e,handlerKey:n})}}function b(e){return(t,n,r)=>{t.__routes||=[],t.__routes.push({method:`OPTIONS`,path:e,handlerKey:n})}}function x(e){return(t,n,r)=>{t.__routes||=[],t.__routes.push({method:`CONNECT`,path:e,handlerKey:n})}}function S(e){return(t,n,r)=>{t.__routes||=[],t.__routes.push({method:`TRACE`,path:e,handlerKey:n})}}const C=async e=>{let t=await import(e);typeof t.default!=`function`&&(a.log(r.red(`Error:`),`${e.split(`/routes`)[1]} has no default class or +route.ts file is not defined`),process.exit(1));let n=Reflect.getMetadata(c,t.default)??void 0;(!n||!n.isRouter)&&(a.log(r.bgRed(`Error:`),`${e.split(`/routes/`)[1]} is not a valid router please attach '@DefRoute()' to the default class `),process.exit(1))},w=async e=>{try{let t=await import(e),n=Reflect.getMetadata(l,t.default)||[],r=Reflect.getMetadata(u,t.default)||[];for(let e of r??[]){let t=n.findIndex(t=>t.id===e.id&&t.handlerKey===e.handlerKey);t!==-1&&n[t]?.middlewares.push(e)}return n}catch(e){console.log(`proccess routes`,e)}},T=async({filePath:e,handlerKey:t,req:n,res:r})=>{let i=await import(e);if(typeof i.default!=`function`)throw Error(`Default export is not a function`);return new i.default()[t](n,r)};async function E(e){let t=[];try{let n=await o(e,{withFileTypes:!0});for(let r of n){let n=s.join(e,r.name);r.isDirectory()&&(t.push(n),t=t.concat(await E(n)))}}catch{}return t}async function D(e){let t=await import(`tcp-port-used`);return new Promise((n,r)=>{t.check(e,`127.0.0.1`).then(e=>{n({isInUse:e})},e=>{r(e.message)})})}const O={CONTINUE:100,SWITCHING_PROTOCOLS:101,PROCESSING:102,EARLY_HINTS:103,OK:200,CREATED:201,ACCEPTED:202,NON_AUTHORITATIVE_INFORMATION:203,NO_CONTENT:204,RESET_CONTENT:205,PARTIAL_CONTENT:206,MULTI_STATUS:207,ALREADY_REPORTED:208,IM_USED:226,MULTIPLE_CHOICES:300,MOVED_PERMANENTLY:301,FOUND:302,SEE_OTHER:303,NOT_MODIFIED:304,USE_PROXY:305,TEMPORARY_REDIRECT:307,PERMANENT_REDIRECT:308,BAD_REQUEST:400,UNAUTHORIZED:401,PAYMENT_REQUIRED:402,FORBIDDEN:403,NOT_FOUND:404,METHOD_NOT_ALLOWED:405,NOT_ACCEPTABLE:406,PROXY_AUTHENTICATION_REQUIRED:407,REQUEST_TIMEOUT:408,CONFLICT:409,GONE:410,LENGTH_REQUIRED:411,PRECONDITION_FAILED:412,PAYLOAD_TOO_LARGE:413,URI_TOO_LONG:414,UNSUPPORTED_MEDIA_TYPE:415,RANGE_NOT_SATISFIABLE:416,EXPECTATION_FAILED:417,IM_A_TEAPOT:418,MISDIRECTED_REQUEST:421,UNPROCESSABLE_ENTITY:422,LOCKED:423,FAILED_DEPENDENCY:424,TOO_EARLY:425,UPGRADE_REQUIRED:426,PRECONDITION_REQUIRED:428,TOO_MANY_REQUESTS:429,REQUEST_HEADER_FIELDS_TOO_LARGE:431,UNAVAILABLE_FOR_LEGAL_REASONS:451,INTERNAL_SERVER_ERROR:500,NOT_IMPLEMENTED:501,BAD_GATEWAY:502,SERVICE_UNAVAILABLE:503,GATEWAY_TIMEOUT:504,HTTP_VERSION_NOT_SUPPORTED:505,VARIANT_ALSO_NEGOTIATES:506,INSUFFICIENT_STORAGE:507,LOOP_DETECTED:508,NOT_EXTENDED:510,NETWORK_AUTHENTICATION_REQUIRED:511};var k=class{eventListeners={};on(e,t){let n=this.eventListeners[e]??new Set;n.add(t),this.eventListeners[e]=n}emit(e,...t){let n=this.eventListeners[e];for(let e of n)e(...t)}};function A(e,t){return e.length>=t?e.slice(0,t):e.padEnd(t,` `)}function j(e){return e>=500?r.red(e):e>=400?r.yellow(e):e>=300?r.cyan(e):r.green(e)}function M(e){return e>1e3?r.red(`${e.toFixed(3)}ms`):e>500?r.yellow(`${e.toFixed(3)}ms`):r.grey(`${e.toFixed(3)}ms`)}const N=new k;N.on(`api:log`,(e,t,n,i)=>{let o=performance.now()-e,s=A(n?.toUpperCase()??`GET`,6),c=A(i.toString(),6),l=A(t??`/`,10);a.log(r.bold(s),j(Number(c)),l,M(o))});async function P(e){return new Promise((t,n)=>{let r=``;e.on(`data`,e=>{r+=e.toString()}),e.on(`end`,()=>{t(JSON.parse(r))})})}function F({middlewares:e,req:t,res:n,onRunRoute:r}){let i=0,a=!1;function o(s){if(a)return;if(s){console.log(s),a=!0,n.end(JSON.stringify({message:`error`})),n.writeHead(O.INTERNAL_SERVER_ERROR),n.end(JSON.stringify({message:`Internal Server Error`})),N.emit(`api:log`,t.__meta.startTime,t.url,t.method,O.INTERNAL_SERVER_ERROR);return}if(n.writableEnded){N.emit(`api:log`,t.__meta.startTime,t.url,t.method,n.statusCode),a=!0;return}let c=e[i++];if(!c){a=!0;try{r(t,n)}catch{n.writeHead(O.INTERNAL_SERVER_ERROR),n.end(JSON.stringify({message:`Internal Server Error`})),N.emit(`api:log`,t.__meta.startTime,t.url,t.method,O.INTERNAL_SERVER_ERROR)}return}try{let e=c.handler({req:t,res:n,next:o});e instanceof Promise&&e.catch(o)}catch(e){o(e)}}o()}async function I({req:e,res:t,routes:n}){e.__meta??={};let r=performance.now();e.__meta.startTime=r;let i=n.filter(t=>e.url?.startsWith(t.baseRoute));if(!i.length)return t.writeHead(O.NOT_FOUND,{"content-type":`application/json`}),N.emit(`api:log`,e.__meta.startTime,e.url,e.method,O.NOT_FOUND),t.end(JSON.stringify({message:`Route Not Found`}));for(let n of i)for(let r of n.subRoutes)if(e.url===`${n.baseRoute}${r.path}`&&e.method?.toLocaleLowerCase()===r.method.toLocaleLowerCase().trim()){let i={};[`post`,`patch`,`put`].includes(e.method.toLocaleLowerCase())&&(i=await P(e),e.body=i),F({middlewares:r.middlewares.reverse(),req:e,res:t,onRunRoute:async(e,t)=>{await T({filePath:`${n.filePath}/+route.ts`,handlerKey:r.handlerKey,req:e,res:t})}})}}function L(){let e;return{config:t=>{e=t},serve:async t=>{let r=new i,o=Date.now(),s=`${e.root}/src/routes`,c=[];(await D(e.port)).isInUse&&(a.error(`Port is already in use by another process.`),process.exit(1));let l=await import(`ip`),u=`Local: `.padEnd(10),d=`Network: `.padEnd(10);a.log(`\n${u}`,`http://localhost:${e.port}`),a.log(d,`http://${l.address()}:${e.port}\n`);let f=await E(s);f.length||(a.error(`Routes Not Found:`,`Please add +routes files in ./src/routes/<base-route>/+route`),process.exit(1));for(let e of f){let t=(e.split(`src/routes`)[1]??`/`).replace(`[id]`,`:id`);c.push({baseRoute:t,subRoutes:[],filePath:e})}for(let e of c)C(`${e.filePath}/+route.ts`);await Promise.all(c.map(async(e,t)=>{let n=await w(`${e.filePath}/+route.ts`);c[t].subRoutes=n??[]})),n(async(e,t)=>{I({req:e,res:t,routes:c})}).listen(e.port,`0.0.0.0`,async()=>{if(t!==void 0)t();else{let e=((Date.now()-o)/1e3).toFixed(2);a.info(r.yellow(`Booting Up...`)),a.success(`Server is ready! (${e}s)`,`

`)}})}}}function R(e,t){return async(n,r)=>{try{let i=await e({req:n,res:r}),a=t?.transform?t.transform(i):i,o=t?.successStatus??200;r.writeHead(o),r.end(JSON.stringify(a)),N.emit(`api:log`,n.__meta.startTime,n.url,n.method,o);return}catch{r.writeHead(O.INTERNAL_SERVER_ERROR),r.end(JSON.stringify({message:`Internal Server Error`})),N.emit(`api:log`,n.__meta.startTime,n.url,n.method,O.INTERNAL_SERVER_ERROR);return}}}export{x as Connect,f as DefRoute,v as Delete,m as Get,y as Head,b as Options,_ as Patch,h as Post,g as Put,L as Server,S as Trace,p as Use,R as controllerHandler};
//# sourceMappingURL=index.mjs.map